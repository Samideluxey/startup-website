from flask import Flask, render_template, request, redirect, url_for, flash, jsonify\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom datetime import datetime\nfrom config import DevelopmentConfig\nimport json\n\napp = Flask(__name__)\napp.config.from_object(DevelopmentConfig)\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'\n\n# ==================== DATENBANK MODELLE ====================\n\nclass User(UserMixin, db.Model):\n    __tablename__ = 'users'\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(80), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password_hash = db.Column(db.String(200), nullable=False)\n    is_admin = db.Column(db.Boolean, default=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    tickets = db.relationship('Ticket', backref='author', lazy=True, cascade='all, delete-orphan')\n    \n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\nclass Ticket(db.Model):\n    __tablename__ = 'tickets'\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text, nullable=False)\n    category = db.Column(db.String(50), default='General')\n    status = db.Column(db.String(20), default='Open')\n    priority = db.Column(db.String(20), default='Normal')\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    response = db.Column(db.Text)\n    \n    def to_dict(self):\n        return {\n            'id': self.id,\n            'title': self.title,\n            'description': self.description,\n            'category': self.category,\n            'status': self.status,\n            'priority': self.priority,\n            'created_at': self.created_at.strftime('%Y-%m-%d %H:%M'),\n            'username': self.author.username\n        }\n\nclass Settings(db.Model):\n    __tablename__ = 'settings'\n    id = db.Column(db.Integer, primary_key=True)\n    site_name = db.Column(db.String(200), default='Startup Website')\n    site_description = db.Column(db.Text, default='Welcome to our startup')\n    hero_title = db.Column(db.String(300), default='Welcome to Our Startup')\n    hero_subtitle = db.Column(db.Text, default='Build something amazing')\n    feature_1_title = db.Column(db.String(200), default='Feature 1')\n    feature_1_desc = db.Column(db.Text, default='Description 1')\n    feature_2_title = db.Column(db.String(200), default='Feature 2')\n    feature_2_desc = db.Column(db.Text, default='Description 2')\n    feature_3_title = db.Column(db.String(200), default='Feature 3')\n    feature_3_desc = db.Column(db.Text, default='Description 3')\n    contact_email = db.Column(db.String(120), default='contact@startup.com')\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n\n# ==================== LOGIN MANAGER ====================\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n# ==================== PUBLIC ROUTES ====================\n\n@app.route('/')\ndef index():\n    settings = Settings.query.first() or Settings()\n    total_users = User.query.count()\n    total_tickets = Ticket.query.count()\n    open_tickets = Ticket.query.filter_by(status='Open').count()\n    \n    return render_template('index.html', \n                         settings=settings,\n                         total_users=total_users,\n                         total_tickets=total_tickets,\n                         open_tickets=open_tickets)\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        email = request.form.get('email')\n        password = request.form.get('password')\n        confirm_password = request.form.get('confirm_password')\n        \n        if not username or not email or not password:\n            flash('Alle Felder sind erforderlich!', 'danger')\n            return redirect(url_for('register'))\n        \n        if password != confirm_password:\n            flash('Passwörter stimmen nicht überein!', 'danger')\n            return redirect(url_for('register'))\n        \n        if User.query.filter_by(username=username).first():\n            flash('Benutzername existiert bereits!', 'danger')\n            return redirect(url_for('register'))\n        \n        if User.query.filter_by(email=email).first():\n            flash('Email existiert bereits!', 'danger')\n            return redirect(url_for('register'))\n        \n        user = User(username=username, email=email)\n        user.set_password(password)\n        db.session.add(user)\n        db.session.commit()\n        \n        flash('Registrierung erfolgreich! Bitte melden Sie sich an.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('register.html')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n        \n        user = User.query.filter_by(username=username).first()\n        \n        if user and user.check_password(password):\n            login_user(user)\n            flash(f'Willkommen {username}!', 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash('Ungültiger Benutzername oder Passwort!', 'danger')\n    \n    return render_template('login.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('Sie wurden abgemeldet.', 'info')\n    return redirect(url_for('index'))\n\n# ==================== USER DASHBOARD ====================\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    user_tickets = Ticket.query.filter_by(user_id=current_user.id).all()\n    stats = {\n        'total_tickets': len(user_tickets),\n        'open': len([t for t in user_tickets if t.status == 'Open']),\n        'in_progress': len([t for t in user_tickets if t.status == 'In Progress']),\n        'closed': len([t for t in user_tickets if t.status == 'Closed'])\n    }\n    \n    return render_template('dashboard.html', tickets=user_tickets, stats=stats)\n\n# ==================== SUPPORT / TICKETS ====================\n\n@app.route('/support')\n@login_required\ndef support():\n    page = request.args.get('page', 1, type=int)\n    tickets = Ticket.query.filter_by(user_id=current_user.id).paginate(page=page, per_page=10)\n    return render_template('support.html', tickets=tickets)\n\n@app.route('/support/new', methods=['GET', 'POST'])\n@login_required\ndef create_ticket():\n    if request.method == 'POST':\n        title = request.form.get('title')\n        description = request.form.get('description')\n        category = request.form.get('category', 'General')\n        priority = request.form.get('priority', 'Normal')\n        \n        if not title or not description:\n            flash('Titel und Beschreibung sind erforderlich!', 'danger')\n            return redirect(url_for('create_ticket'))\n        \n        ticket = Ticket(\n            title=title,\n            description=description,\n            category=category,\n            priority=priority,\n            user_id=current_user.id\n        )\n        db.session.add(ticket)\n        db.session.commit()\n        \n        flash(f'Ticket #{ticket.id} wurde erstellt!', 'success')\n        return redirect(url_for('view_ticket', ticket_id=ticket.id))\n    \n    return render_template('ticket.html')\n\n@app.route('/support/ticket/<int:ticket_id>')\n@login_required\ndef view_ticket(ticket_id):\n    ticket = Ticket.query.get_or_404(ticket_id)\n    \n    if ticket.user_id != current_user.id and not current_user.is_admin:\n        flash('Sie haben keinen Zugriff auf dieses Ticket!', 'danger')\n        return redirect(url_for('support'))\n    \n    return render_template('ticket_detail.html', ticket=ticket)\n\n@app.route('/api/ticket/<int:ticket_id>/close', methods=['POST'])\n@login_required\ndef close_ticket(ticket_id):\n    ticket = Ticket.query.get_or_404(ticket_id)\n    \n    if ticket.user_id != current_user.id and not current_user.is_admin:\n        return jsonify({'error': 'Unauthorized'}), 403\n    \n    ticket.status = 'Closed'\n    db.session.commit()\n    \n    return jsonify({'success': True, 'message': 'Ticket closed'})\n\n# ==================== ADMIN DASHBOARD ====================\n\n@app.route('/admin')\n@login_required\ndef admin_dashboard():\n    if not current_user.is_admin:\n        flash('Sie haben keinen Admin-Zugriff!', 'danger')\n        return redirect(url_for('index'))\n    \n    total_users = User.query.count()\n    total_tickets = Ticket.query.count()\n    open_tickets = Ticket.query.filter_by(status='Open').count()\n    closed_tickets = Ticket.query.filter_by(status='Closed').count()\n    \n    from datetime import timedelta\n    thirty_days_ago = datetime.utcnow() - timedelta(days=30)\n    recent_tickets = Ticket.query.filter(Ticket.created_at >= thirty_days_ago).all()\n    \n    stats = {\n        'total_users': total_users,\n        'total_tickets': total_tickets,\n        'open_tickets': open_tickets,\n        'closed_tickets': closed_tickets,\n        'recent_tickets': len(recent_tickets)\n    }\n    \n    return render_template('admin_dashboard.html', stats=stats)\n\n@app.route('/admin/users')\n@login_required\ndef admin_users():\n    if not current_user.is_admin:\n        flash('Sie haben keinen Admin-Zugriff!', 'danger')\n        return redirect(url_for('index'))\n    \n    page = request.args.get('page', 1, type=int)\n    users = User.query.paginate(page=page, per_page=20)\n    return render_template('admin_users.html', users=users)\n\n@app.route('/admin/user/<int:user_id>/toggle-admin', methods=['POST'])\n@login_required\ndef toggle_admin(user_id):\n    if not current_user.is_admin:\n        return jsonify({'error': 'Unauthorized'}), 403\n    \n    user = User.query.get_or_404(user_id)\n    if user.id == current_user.id:\n        return jsonify({'error': 'Cannot toggle yourself'}), 400\n    \n    user.is_admin = not user.is_admin\n    db.session.commit()\n    \n    return jsonify({'success': True, 'is_admin': user.is_admin})\n\n@app.route('/admin/user/<int:user_id>/delete', methods=['POST'])\n@login_required\ndef delete_user(user_id):\n    if not current_user.is_admin:\n        return jsonify({'error': 'Unauthorized'}), 403\n    \n    user = User.query.get_or_404(user_id)\n    if user.id == current_user.id:\n        return jsonify({'error': 'Cannot delete yourself'}), 400\n    \n    db.session.delete(user)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'message': 'User deleted'})\n\n@app.route('/admin/tickets')\n@login_required\ndef admin_tickets():\n    if not current_user.is_admin:\n        flash('Sie haben keinen Admin-Zugriff!', 'danger')\n        return redirect(url_for('index'))\n    \n    page = request.args.get('page', 1, type=int)\n    status = request.args.get('status', 'all')\n    \n    if status != 'all':\n        tickets = Ticket.query.filter_by(status=status).paginate(page=page, per_page=20)\n    else:\n        tickets = Ticket.query.paginate(page=page, per_page=20)\n    \n    return render_template('admin_tickets.html', tickets=tickets, status=status)\n\n@app.route('/admin/ticket/<int:ticket_id>', methods=['GET', 'POST'])\n@login_required\ndef admin_view_ticket(ticket_id):\n    if not current_user.is_admin:\n        return redirect(url_for('index'))\n    \n    ticket = Ticket.query.get_or_404(ticket_id)\n    \n    if request.method == 'POST':\n        response = request.form.get('response')\n        status = request.form.get('status')\n        \n        if response:\n            ticket.response = response\n        if status:\n            ticket.status = status\n        \n        db.session.commit()\n        flash('Ticket aktualisiert!', 'success')\n        return redirect(url_for('admin_view_ticket', ticket_id=ticket.id))\n    \n    return render_template('admin_ticket_detail.html', ticket=ticket)\n\n@app.route('/admin/settings', methods=['GET', 'POST'])\n@login_required\ndef admin_settings():\n    if not current_user.is_admin:\n        flash('Sie haben keinen Admin-Zugriff!', 'danger')\n        return redirect(url_for('index'))\n    \n    settings = Settings.query.first()\n    if not settings:\n        settings = Settings()\n        db.session.add(settings)\n        db.session.commit()\n    \n    if request.method == 'POST':\n        settings.site_name = request.form.get('site_name')\n        settings.site_description = request.form.get('site_description')\n        settings.hero_title = request.form.get('hero_title')\n        settings.hero_subtitle = request.form.get('hero_subtitle')\n        settings.feature_1_title = request.form.get('feature_1_title')\n        settings.feature_1_desc = request.form.get('feature_1_desc')\n        settings.feature_2_title = request.form.get('feature_2_title')\n        settings.feature_2_desc = request.form.get('feature_2_desc')\n        settings.feature_3_title = request.form.get('feature_3_title')\n        settings.feature_3_desc = request.form.get('feature_3_desc')\n        settings.contact_email = request.form.get('contact_email')\n        \n        db.session.commit()\n        flash('Einstellungen aktualisiert!', 'success')\n        return redirect(url_for('admin_settings'))\n    \n    return render_template('admin_settings.html', settings=settings)\n\n@app.route('/admin/stats')\n@login_required\ndef admin_stats():\n    if not current_user.is_admin:\n        return jsonify({'error': 'Unauthorized'}), 403\n    \n    tickets_by_status = {}\n    for status in ['Open', 'In Progress', 'Closed']: \n        tickets_by_status[status] = Ticket.query.filter_by(status=status).count()\n    \n    tickets_by_priority = {}\n    for priority in ['Low', 'Normal', 'High']: \n        tickets_by_priority[priority] = Ticket.query.filter_by(priority=priority).count()\n\n    return jsonify({\n        'by_status': tickets_by_status,\n        'by_priority': tickets_by_priority,\n        'total_users': User.query.count(),\n        'total_tickets': Ticket.query.count()\n    })\n\n# ==================== ERROR HANDLING ====================\n\n@app.errorhandler(404)\ndef not_found(error):\n    return render_template('404.html'), 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    db.session.rollback()\n    return render_template('500.html'), 500\n\n# ==================== DATABASE INITIALIZATION ====================\n\ndef init_db():\n    with app.app_context():\n        db.create_all()\n        \n        if not Settings.query.first():\n            settings = Settings()\n            db.session.add(settings)\n        \n        if not User.query.filter_by(is_admin=True).first():\n            admin = User(\n                username='admin',\n                email='admin@startup.com',\n                is_admin=True\n            )\n            admin.set_password('admin123')\n            db.session.add(admin)\n        \n        db.session.commit()\n        print("✅ Datenbank initialisiert!")\n\nif __name__ == '__main__':\n    init_db()\n    app.run(debug=True, host='0.0.0.0', port=5000)\n